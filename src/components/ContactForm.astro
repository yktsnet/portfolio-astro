---
interface Props {
  turnstileSiteKey?: string;
}

const { turnstileSiteKey = '' } = Astro.props;
---

<section class="mt-20 border-t border-zinc-200 pt-10 dark:border-zinc-700/40">
  <h2 class="mb-8 text-lg font-bold tracking-tight text-zinc-900 dark:text-poi-focus">Contact</h2>

  <form id="contact-form" class="space-y-4 max-w-md">
    <div>
      <label for="cf-name" class="block text-sm font-semibold text-zinc-700 dark:text-poi-focus/90 mb-1">Name <span class="text-red-400">*</span></label>
      <input
        type="text"
        id="cf-name"
        name="name"
        required
        class="w-full rounded-md border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-800/50 px-3 py-2 text-sm text-zinc-900 dark:text-poi-focus placeholder-zinc-400 dark:placeholder-zinc-500 focus:border-light-accent dark:focus:border-poi-accent focus:outline-none transition-colors"
      />
    </div>

    <div>
      <label for="cf-email" class="block text-sm font-semibold text-zinc-700 dark:text-poi-focus/90 mb-1">Email <span class="text-red-400">*</span></label>
      <input
        type="email"
        id="cf-email"
        name="email"
        required
        class="w-full rounded-md border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-800/50 px-3 py-2 text-sm text-zinc-900 dark:text-poi-focus placeholder-zinc-400 dark:placeholder-zinc-500 focus:border-light-accent dark:focus:border-poi-accent focus:outline-none transition-colors"
      />
    </div>

    <div>
      <label for="cf-phone" class="block text-sm font-semibold text-zinc-700 dark:text-poi-focus/90 mb-1">Phone <span class="text-red-400">*</span></label>
      <input
        type="tel"
        id="cf-phone"
        name="phone"
        required
        class="w-full rounded-md border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-800/50 px-3 py-2 text-sm text-zinc-900 dark:text-poi-focus placeholder-zinc-400 dark:placeholder-zinc-500 focus:border-light-accent dark:focus:border-poi-accent focus:outline-none transition-colors"
      />
    </div>

    <div>
      <label for="cf-message" class="block text-sm font-semibold text-zinc-700 dark:text-poi-focus/90 mb-1">Message</label>
      <textarea
        id="cf-message"
        name="message"
        rows="4"
        class="w-full rounded-md border border-zinc-300 dark:border-zinc-600 bg-zinc-50 dark:bg-zinc-800/50 px-3 py-2 text-sm text-zinc-900 dark:text-poi-focus placeholder-zinc-400 dark:placeholder-zinc-500 focus:border-light-accent dark:focus:border-poi-accent focus:outline-none transition-colors resize-y"
      ></textarea>
    </div>

    {turnstileSiteKey && (
      <div class="cf-turnstile" data-sitekey={turnstileSiteKey} data-theme="auto"></div>
    )}

    <button
      type="submit"
      class="rounded-md bg-light-accent dark:bg-poi-accent px-4 py-2 text-sm font-semibold text-white dark:text-zinc-900 hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
    >
      Send
    </button>

    <p id="cf-status" class="text-sm hidden"></p>
  </form>
</section>

{turnstileSiteKey && (
  <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
)}

<script is:inline>
  document.getElementById('contact-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    const status = document.getElementById('cf-status');

    btn.disabled = true;
    btn.textContent = 'Sending...';
    status.classList.add('hidden');

    const body = {
      name: form.name.value,
      email: form.email.value,
      phone: form.phone.value,
      message: form.message.value,
      cfToken: form.querySelector('[name="cf-turnstile-response"]')?.value || '',
    };

    try {
      const res = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      status.classList.remove('hidden');
      if (data.ok) {
        status.textContent = 'Thank you! Your message has been sent.';
        status.className = 'text-sm text-green-600 dark:text-green-400';
        form.reset();
      } else {
        status.textContent = 'Failed to send. Please try again.';
        status.className = 'text-sm text-red-500';
      }
    } catch {
      status.classList.remove('hidden');
      status.textContent = 'Network error. Please try again.';
      status.className = 'text-sm text-red-500';
    } finally {
      btn.disabled = false;
      btn.textContent = 'Send';
    }
  });
</script>
