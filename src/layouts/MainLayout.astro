---
import '@fontsource/fira-code';
import "../styles/global.css";
import Search from '../components/Search.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import Logo from './Logo.astro';
import { siteConfig, menuLinks } from '../site.config';

interface Props {
  title?: string;
  description?: string;
}

const { title = "Home", description = siteConfig.description } = Astro.props;
const fullTitle = `${title} ‚Ä¢ ${siteConfig.title}`;
const canonicalURL = new URL(Astro.url.pathname, siteConfig.url);
const year = new Date().getFullYear();
---
<html lang={siteConfig.lang} class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{fullTitle}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    {/* OGP */}
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:locale" content={siteConfig.ogLocale} />
    <meta property="og:site_name" content={siteConfig.title} />
    {/* Inline SVG favicon - pinwheel icon */}
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'><path d='M22 12a1 1 0 0 1-10 0a1 1 0 0 0-10 0' stroke='%235de4c7'/><path d='M7 20.7a1 1 0 1 1 5-8.7a1 1 0 1 0 5-8.6' stroke='%23d482ab'/><path d='M7 3.3a1 1 0 1 1 5 8.6a1 1 0 1 0 5 8.6' stroke='%2389ddff'/><circle cx='12' cy='12' r='2.5' fill='%23cdffb8'/></svg>" type="image/svg+xml" />
    <script is:inline>
      const theme = (() => {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      })();
      if (theme === 'light') {
        document.documentElement.classList.remove('dark');
      } else {
        document.documentElement.classList.add('dark');
      }
    </script>
    {/* Prevent icon FOUC: set explicit dimensions before CSS loads */}
    <style is:inline>
      .site-logo-icon {
        width: 1.5rem;
        height: 2.5rem;
      }
      @media (min-width: 640px) {
        .site-logo-icon {
          width: 3rem;
          height: 5rem;
        }
      }
    </style>
  </head>
  
<body class="bg-zinc-50 text-zinc-900 dark:bg-poi-base dark:text-poi-focus mx-auto flex min-h-screen max-w-3xl flex-col px-4 pt-16 font-mono text-sm font-normal antialiased sm:px-8 transition-colors duration-300">
    
    {/* ===== HEADER ===== */}
    <header class="group relative mb-28 flex items-center sm:ps-[4.5rem]" id="main-header">
      <div class="relative flex sm:flex-col">
        {/* Pinwheel icon: mobile=inline inside link, PC=absolute centered against title+nav group */}
        <div class="group/logo hidden sm:block sm:absolute sm:-start-[4.5rem] sm:top-1/2 sm:-translate-y-1/2 sm:grayscale sm:hover:filter-none sm:transition-[filter]">
          <Logo class="site-logo-icon transition-transform duration-500 ease-out group-hover/logo:rotate-180" />
        </div>
        <a
          aria-current={Astro.url.pathname === "/" ? "page" : false}
          class="inline-flex items-center"
          href="/"
        >
          {/* Mobile-only inline icon (colored) */}
          <div class="group/logo me-3 sm:hidden">
            <Logo class="site-logo-icon transition-transform duration-500 ease-out group-hover/logo:rotate-180" />
          </div>
          <span class="text-xl font-bold sm:text-2xl text-zinc-900 dark:text-poi-focus">Katsuhiro Yamakawa</span>
        </a>
        {/* Nav: hidden on mobile, shown via hamburger toggle */}
        <nav
          aria-label="Main menu"
          class="bg-zinc-50 dark:bg-poi-base absolute -inset-x-4 top-14 hidden flex-col divide-y px-2 py-4 group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:divide-x sm:divide-y-0 sm:divide-light-accent dark:sm:divide-poi-accent sm:bg-transparent sm:p-0"
          id="navigation-menu"
        >
          {menuLinks.map((link) => (
            <a
              aria-current={Astro.url.pathname === link.path ? "page" : false}
              class="text-light-accent dark:text-poi-accent px-2 py-4 font-semibold sm:px-4 sm:py-0 sm:underline-offset-2 sm:hover:underline"
              href={link.path}
            >
              {link.title}
            </a>
          ))}
        </nav>
      </div>
      {/* Right: Search, Theme, Mobile hamburger */}
      <Search />
      <ThemeToggle />
      <mobile-button>
        <button
          aria-expanded="false"
          aria-haspopup="menu"
          class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden"
          id="toggle-navigation-menu"
          type="button"
        >
          <span class="sr-only">Open main menu</span>
          <svg
            aria-hidden="true"
            class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0"
            fill="none"
            focusable="false"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
          <svg
            aria-hidden="true"
            class="text-light-accent dark:text-poi-accent absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100"
            fill="none"
            focusable="false"
            stroke="currentColor"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </mobile-button>
    </header>

    <main id="main" class="flex-1">
      <slot />
    </main>

    {/* ===== FOOTER ===== */}
    <footer
      class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pt-20 pb-4 text-center align-top font-semibold text-zinc-500 dark:text-poi-muted/50 sm:flex-row sm:justify-between sm:text-xs"
    >
      <div class="me-0 sm:me-4">
        &copy; Katsuhiro Yamakawa {year}.<span class="inline-block">&nbsp;üêà&nbsp;ykts.net</span>
      </div>
      <nav
        aria-labelledby="footer_links"
        class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-zinc-400 dark:sm:divide-poi-muted/30"
      >
        <p id="footer_links" class="sr-only">More on this site</p>
        {menuLinks.map((link) => (
          <a
            class="px-4 py-2 hover:text-zinc-900 dark:hover:text-poi-focus hover:underline sm:py-0"
            href={link.path}
          >
            {link.title}
          </a>
        ))}
      </nav>
    </footer>

    {/* ===== Mobile menu script ===== */}
    <script>
      class MobileNavBtn extends HTMLElement {
        #menuOpen: boolean = false;

        connectedCallback() {
          const headerEl = document.getElementById("main-header")!;
          const mobileButtonEl = this.querySelector<HTMLButtonElement>("button");

          mobileButtonEl?.addEventListener("click", () => {
            if (headerEl) headerEl.classList.toggle("menu-open");
            this.#menuOpen = !this.#menuOpen;
            mobileButtonEl.setAttribute("aria-expanded", this.#menuOpen.toString());
          });
        }
      }

      customElements.define("mobile-button", MobileNavBtn);
    </script>
  </body>
</html>
