---
import { render } from "astro:content";
import PostPreview from "../../../components/blog/PostPreview.astro";
import Pagination from "../../../components/Paginator.astro";
import { getAllPosts, getTagMeta } from "../../../data/post";
import MainLayout from "../../../layouts/MainLayout.astro";
import { collectionDateSort } from "../../../utils/date";

const { tag, page: pageParam } = Astro.params;

if (!tag) return Astro.redirect("/tags/");

const currentPage = Number(pageParam) || 1;
const PAGE_SIZE = 10;

const allPosts = await getAllPosts();
const sortedPosts = allPosts.sort(collectionDateSort);
const postsWithTag = sortedPosts.filter((post) => post.data.tags.includes(tag));

if (postsWithTag.length === 0) return Astro.redirect("/tags/");

const totalPages = Math.ceil(postsWithTag.length / PAGE_SIZE);
const start = (currentPage - 1) * PAGE_SIZE;
const paginatedPosts = postsWithTag.slice(start, start + PAGE_SIZE);

const tagMeta = await getTagMeta(tag);
const TagContent = tagMeta ? (await render(tagMeta)).Content : null;

const paginationProps = {
  ...(currentPage > 1 && {
    prevUrl: {
      text: "← Previous",
      url: currentPage === 2 ? `/tags/${tag}/` : `/tags/${tag}/${currentPage - 1}/`,
    },
  }),
  ...(currentPage < totalPages && {
    nextUrl: {
      text: "Next →",
      url: `/tags/${tag}/${currentPage + 1}/`,
    },
  }),
};
---

<MainLayout title={tagMeta?.data.title ?? `Posts about ${tag}`}>
  <nav class="mb-8" aria-label="Breadcrumbs">
    <ul class="flex items-center gap-1 text-sm">
      <li>
        <a class="text-[#d0679d] dark:text-[#5de4c7]" href="/tags/">Tags</a>
      </li>
      <li class="text-zinc-500">›</li>
      <li aria-current="page"><span aria-hidden="true">#</span>{tag}</li>
    </ul>
  </nav>
  <h1 class="mb-4 text-2xl font-bold capitalize text-zinc-900 dark:text-[#e4f0fb]">{tagMeta?.data.title ?? `Posts about ${tag}`}</h1>
  {tagMeta?.data.description && <p class="mb-4 text-zinc-600 dark:text-[#a6accd]">{tagMeta.data.description}</p>}
  {TagContent && <div class="prose prose-sm mb-8 max-w-none dark:prose-invert"><TagContent /></div>}
  <ul class="space-y-4">
    {
      paginatedPosts.map((p) => (
        <li class="grid gap-1 sm:grid-cols-[auto_1fr]">
          <PostPreview as="h2" post={p} />
        </li>
      ))
    }
  </ul>
  <Pagination {...paginationProps} />
</MainLayout>
