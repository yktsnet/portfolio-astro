---
import { render, getCollection } from "astro:content";
import Masthead from "../../components/blog/Masthead.astro";
import MainLayout from "../../layouts/MainLayout.astro";

const { slug } = Astro.params;

const allPosts = await getCollection("post");
const post = allPosts.find((p) => p.id === slug);

if (!post) {
  return Astro.redirect("/404");
}

const { Content } = await render(post);
---

<MainLayout title={post.data.title}>
  <article class="grow break-words" data-pagefind-body>
    <div id="blog-hero" class="mb-12">
      <Masthead content={post} />
    </div>
    <div
      class="prose prose-sm max-w-none
        prose-headings:font-semibold prose-headings:text-zinc-900 dark:prose-headings:text-[#e4f0fb]
        prose-p:text-zinc-700 dark:prose-p:text-[#e4f0fb]/90
        prose-a:text-[#d0679d] dark:prose-a:text-[#5de4c7] prose-a:underline prose-a:underline-offset-2
        prose-strong:text-zinc-900 dark:prose-strong:text-[#e4f0fb]
        prose-code:text-[#d0679d] dark:prose-code:text-[#5de4c7]
        prose-blockquote:border-[#d0679d] dark:prose-blockquote:border-[#5de4c7]
        prose-li:text-zinc-700 dark:prose-li:text-[#e4f0fb]/90
        prose-pre:bg-zinc-950 dark:prose-pre:bg-[#232735]
        prose-th:text-zinc-900 dark:prose-th:text-[#e4f0fb]
        prose-td:text-zinc-700 dark:prose-td:text-[#e4f0fb]/90
        font-sans"
    >
      <Content />
    </div>
  </article>

  <button
    class="fixed end-4 bottom-8 z-50 flex h-10 w-10 cursor-pointer items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-300 opacity-0 transition-all duration-300 hover:border-[#d0679d] dark:hover:border-[#5de4c7] sm:end-8 sm:h-12 sm:w-12"
    id="to-top-btn"
  >
    <span class="sr-only">Back to top</span>
    <svg
      aria-hidden="true"
      class="h-6 w-6"
      fill="none"
      focusable="false"
      stroke="currentColor"
      stroke-width="2"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
  </button>
</MainLayout>

<script>
  const scrollBtn = document.getElementById("to-top-btn") as HTMLButtonElement;
  const targetHeader = document.getElementById("blog-hero") as HTMLDivElement;

  function callback(entries: IntersectionObserverEntry[]) {
    entries.forEach((entry) => {
      scrollBtn.style.opacity = entry.isIntersecting ? "0" : "1";
      scrollBtn.style.pointerEvents = entry.isIntersecting ? "none" : "auto";
    });
  }

  scrollBtn.addEventListener("click", () => {
    document.documentElement.scrollTo({ behavior: "smooth", top: 0 });
  });

  const observer = new IntersectionObserver(callback);
  observer.observe(targetHeader);
</script>
